<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>H·ªçc t·ª´ v·ª±ng ti·∫øng Trung (Offline)</title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 600px; margin: auto; }
    #word { font-size: 24px; margin-bottom: 10px; }
    #result { margin-top: 10px; font-weight: bold; }
    #stats { margin-top: 20px; padding: 10px; background: #f4f4f4; border: 1px solid #ccc; }
    #wrong-list { margin-top: 10px; }
    input[type="text"] { width: 100%; padding: 8px; font-size: 16px; }
    button { margin-top: 5px; margin-right: 5px; }
  </style>
</head>
<body>
  <h2>Flashcard ti·∫øng Trung (Offline)</h2>

  <label>Ch·∫ø ƒë·ªô h·ªçc: </label>
  <select id="mode">
    <option value="cn_to_vi">Ti·∫øng Trung ‚Üí Nghƒ©a</option>
    <option value="vi_to_cn">Nghƒ©a ‚Üí Ti·∫øng Trung</option>
  </select>
  <label style="margin-left: 20px;">
    <input type="checkbox" id="showPinyin" checked> Hi·ªán Pinyin
  </label>

  <div id="word"></div>
  <input type="text" id="answer" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." />
  <button onclick="checkAnswer()">Ki·ªÉm tra</button>
  <button onclick="nextWord()">Ti·∫øp</button>
  <button onclick="speak()">üîä ƒê·ªçc pinyin</button>

  <div id="result"></div>

  <div id="stats">
    <h3>Th·ªëng k√™</h3>
    <p id="total">T·ªïng l∆∞·ª£t luy·ªán: 0</p>
    <p id="correct">Tr·∫£ l·ªùi ƒë√∫ng: 0</p>
    <p id="wrong">Tr·∫£ l·ªùi sai: 0</p>
    <div id="wrong-list"></div>
  </div>

  <script>
    let vocabList = [];
    let current = {};
    let recentWords = [];
    let stats = {
      total: 0,
      correct: 0,
      wrong: 0,
      wrongWords: []
    };

    const wordDiv = document.getElementById('word');
    const resultDiv = document.getElementById('result');
    const answerInput = document.getElementById('answer');
    const modeSelect = document.getElementById('mode');
    const showPinyinCheckbox = document.getElementById('showPinyin');
    const totalP = document.getElementById('total');
    const correctP = document.getElementById('correct');
    const wrongP = document.getElementById('wrong');
    const wrongListDiv = document.getElementById('wrong-list');

    answerInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        checkAnswer();
      }
    });

    showPinyinCheckbox.addEventListener('change', () => {
      updateWordDisplay();
    });

    modeSelect.addEventListener('change', () => {
      updateWordDisplay();
    });

    fetch('tuvung.json')
      .then(response => response.json())
      .then(data => {
        vocabList = data;
        loadStats();
        nextWord();
      })
      .catch(error => {
        alert("‚ùå Kh√¥ng th·ªÉ t·∫£i t·ª´ v·ª±ng. H√£y m·ªü file index.html b·∫±ng tr√¨nh duy·ªát ho·∫∑c ch·∫°y b·∫±ng server c·ª•c b·ªô.");
        console.error("L·ªói t·∫£i JSON:", error);
      });

    function nextWord() {
      resultDiv.textContent = '';
      answerInput.value = '';
      answerInput.style.backgroundColor = 'white';

      let candidate;
      do {
        candidate = vocabList[Math.floor(Math.random() * vocabList.length)];
      } while (recentWords.includes(candidate) && vocabList.length > recentWords.length);

      current = candidate;
      recentWords.push(current);
      if (recentWords.length > 10) recentWords.shift();

      updateWordDisplay();
    }

    function updateWordDisplay() {
      if (!current || Object.keys(current).length === 0) return;

      if (modeSelect.value === 'cn_to_vi') {
        const showPinyin = showPinyinCheckbox.checked;
        wordDiv.textContent = `Ti·∫øng Trung: ${current.Chinese}` +
                              (showPinyin ? ` (${current.Pinyin})` : '');
      } else {
        wordDiv.textContent = `Nghƒ©a: ${current.Meaning}`;
      }
    }

    // ‚úÖ H√†m chu·∫©n h√≥a ti·∫øng Vi·ªát ƒë·ªÉ so s√°nh ch√≠nh x√°c
    function normalizeVN(str) {
      return str.normalize("NFC").trim().toLowerCase();
    }

    function checkAnswer() {
      const userInput = answerInput.value;
      const mode = modeSelect.value;
      let correctAnswer = mode === 'cn_to_vi' ? current.Meaning : current.Chinese;

      const possibleAnswers = correctAnswer
        .split(/[,;]+/)
        .map(part => normalizeVN(part.split('(')[0]));

      stats.total++;

      if (possibleAnswers.includes(normalizeVN(userInput))) {
        stats.correct++;
        resultDiv.innerHTML = `‚úÖ Ch√≠nh x√°c!<br><span style="font-size: 16px;">ƒê·∫ßy ƒë·ªß: ${correctAnswer}</span>`;
        resultDiv.style.color = 'green';
        answerInput.style.backgroundColor = '#d4edda';
        updateStats();
        saveStats();
        setTimeout(nextWord, 2000);
        return;
      } else {
        stats.wrong++;
        resultDiv.textContent = `‚ùå Sai. ƒê√°p √°n ƒë√∫ng: ${possibleAnswers[0]}`;
        resultDiv.style.color = 'red';
        answerInput.style.backgroundColor = '#f8d7da';
        stats.wrongWords.push({
          word: current.Chinese,
          pinyin: current.Pinyin,
          meaning: current.Meaning
        });
      }

      updateStats();
      saveStats();
    }

    function updateStats() {
      totalP.textContent = `T·ªïng l∆∞·ª£t luy·ªán: ${stats.total}`;
      correctP.textContent = `Tr·∫£ l·ªùi ƒë√∫ng: ${stats.correct}`;
      wrongP.textContent = `Tr·∫£ l·ªùi sai: ${stats.wrong}`;

      if (stats.wrongWords.length > 0) {
        wrongListDiv.innerHTML = `<strong>T·ª´ tr·∫£ l·ªùi sai:</strong><ul>` +
          stats.wrongWords.map(w => `<li>${w.word} (${w.pinyin}) - ${w.meaning}</li>`).join('') +
          `</ul>`;
      } else {
        wrongListDiv.innerHTML = '';
      }
    }

    function speak() {
      const utter = new SpeechSynthesisUtterance(current.Pinyin);
      utter.lang = 'zh-CN';
      speechSynthesis.speak(utter);
    }

    function saveStats() {
      localStorage.setItem('vocabStats', JSON.stringify(stats));
    }

    function loadStats() {
      const saved = localStorage.getItem('vocabStats');
      if (saved) {
        stats = JSON.parse(saved);
        updateStats();
      }
    }
  </script>
</body>
</html>
