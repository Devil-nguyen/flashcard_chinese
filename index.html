<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Há»c tá»« vá»±ng tiáº¿ng Trung (Offline)</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background-color: white;
      color: black;
    }
    input, select, button {
      font-size: 16px;
      margin-top: 5px;
    }
    button {
      margin-right: 5px;
    }
    #result.wrong {
      background-color: #f8d7da;
      padding: 10px;
      border-radius: 5px;
    }
    #result.correct {
      background-color: #d4edda;
      padding: 10px;
      border-radius: 5px;
    }
    .dark-mode {
      background-color: #1e1e1e;
      color: #f0f0f0;
    }
    .dark-mode input,
    .dark-mode select,
    .dark-mode button {
      background-color: #2e2e2e;
      color: #f0f0f0;
      border: 1px solid #555;
    }
    @media (max-width: 480px) {
      button {
        display: block;
        width: 100%;
        margin-top: 5px;
      }
    }
  </style>
</head>
<body>
  <h2>Flashcard tiáº¿ng Trung (Offline)</h2>
  <label>Cháº¿ Ä‘á»™ há»c: </label>
  <select id="mode">
    <option value="cn_to_vi">Tiáº¿ng Trung â†’ NghÄ©a</option>
    <option value="vi_to_cn">NghÄ©a â†’ Tiáº¿ng Trung</option>
  </select>
  <label><input id="showPinyin" type="checkbox" checked/> Hiá»‡n Pinyin</label>
  <label><input type="checkbox" id="darkToggle"/> ğŸŒ™ Cháº¿ Ä‘á»™ tá»‘i</label>

  <div id="word" style="font-size:24px; margin:10px 0;"></div>
  <input id="answer" placeholder="Nháº­p cÃ¢u tráº£ lá»i..." type="text" style="width:100%;" />
  <button onclick="checkAnswer()">ğŸ”Kiá»ƒm tra</button>
  <button onclick="nextWord()">â¡ï¸Tiáº¿p</button>
  <button onclick="speak()">ğŸ”Š Äá»c pinyin</button>
  <button id="toggleModeBtn" onclick="toggleLearningMode()">ğŸ“š Há»c tá»« (Táº¥t cáº£)</button><br/>
  <button onclick="resetStats()">â™»ï¸ Reset thá»‘ng kÃª</button>
  <button onclick="exportWrongWords()">ğŸ“¥ Xuáº¥t tá»« sai</button>
  <button onclick="openEdit()">âœï¸ Sá»­a tá»« hiá»‡n táº¡i</button>
  <button onclick="exportEditedWords()">ğŸ“¤ Xuáº¥t tá»« Ä‘Ã£ sá»­a</button>

  <div id="result" style="margin-top:10px;"></div>

  <div id="stats" style="margin-top:20px; background:#f4f4f4; padding:10px;">
    <h3>Thá»‘ng kÃª</h3>
    <p id="total">Tá»•ng lÆ°á»£t luyá»‡n: 0</p>
    <p id="correct">Tráº£ lá»i Ä‘Ãºng: 0</p>
    <p id="wrong">Tráº£ lá»i sai: 0</p>
    <p id="accuracy">Tá»‰ lá»‡ Ä‘Ãºng: 0% - Sai: 0%</p>
    <div id="wrong-list"></div>
  </div>

  <div id="editModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border:1px solid #ccc; z-index:1000;">
    <h3>Sá»­a tá»« hiá»‡n táº¡i</h3>
    <label>Tiáº¿ng Trung: <input id="editChinese" /></label><br/>
    <label>Pinyin: <input id="editPinyin" /></label><br/>
    <label>NghÄ©a: <input id="editMeaning" /></label><br/>
    <button onclick="saveEdit()">ğŸ’¾ LÆ°u</button>
    <button onclick="closeEdit()">âŒ Há»§y</button>
  </div>

  <script>
    let vocabList = [];
    let current = {};
    let stats = { total: 0, correct: 0, wrong: 0, wrongWords: [] };
    let retryMode = false, retryList = [], retryIndex = 0, recentWords = [], editedWords = [];

    const wordDiv = document.getElementById('word');
    const resultDiv = document.getElementById('result');
    const answerInput = document.getElementById('answer');
    const modeSelect = document.getElementById('mode');
    const showPinyinCheckbox = document.getElementById('showPinyin');

    fetch('tuvung.json').then(res => res.json()).then(data => {
      vocabList = data;
      loadStats();
      nextWord();
    });

    function normalizeVN(str) {
      return str.normalize("NFC").trim().toLowerCase();
    }

    function nextWord() {
      resultDiv.textContent = '';
      resultDiv.className = '';
      answerInput.value = '';
      answerInput.style.backgroundColor = 'white';

      if (retryMode && retryList.length > 0) {
        current = retryList[retryIndex % retryList.length];
        retryIndex++;
      } else {
        let candidate;
        do {
          candidate = vocabList[Math.floor(Math.random() * vocabList.length)];
        } while (recentWords.includes(candidate));
        current = candidate;
        recentWords.push(current);
        if (recentWords.length > 10) recentWords.shift();
      }

      updateWordDisplay();
    }

    function updateWordDisplay() {
      if (!current) return;
      let c = current;
      wordDiv.textContent = modeSelect.value === 'cn_to_vi'
        ? `Tiáº¿ng Trung: ${c.Chinese} ${(showPinyinCheckbox.checked ? '(' + c.Pinyin + ')' : '')}`
        : `NghÄ©a: ${c.Meaning}`;
    }

    function checkAnswer() {
      const input = normalizeVN(answerInput.value);
      const correctText = modeSelect.value === 'cn_to_vi' ? current.Meaning : current.Chinese;
      const possible = correctText.split(/[,;]+/).map(x => normalizeVN(x.split('(')[0]));

      stats.total++;

      if (possible.includes(input)) {
        stats.correct++;
        resultDiv.className = 'correct';
        resultDiv.innerHTML = `âœ… ChÃ­nh xÃ¡c!<br><strong>${correctText}</strong>`;
        answerInput.style.backgroundColor = '#d4edda';
        updateStats();
        saveStats();
        setTimeout(nextWord, 1500);
      } else {
        stats.wrong++;
        resultDiv.className = 'wrong';
        resultDiv.innerHTML = `âŒ Sai. ÄÃ¡p Ã¡n Ä‘Ãºng:<br>
          <strong>Tiáº¿ng Trung:</strong> ${current.Chinese}<br>
          <strong>Pinyin:</strong> ${current.Pinyin}<br>
          <strong>NghÄ©a:</strong> ${current.Meaning}`;
        answerInput.style.backgroundColor = '#f8d7da';
        stats.wrongWords.push(current);
        updateStats();
        saveStats();
      }
    }

    function speak() {
      const utter = new SpeechSynthesisUtterance(current.Pinyin);
      utter.lang = 'zh-CN';
      speechSynthesis.speak(utter);
    }

    function updateStats() {
      document.getElementById('total').textContent = `Tá»•ng lÆ°á»£t luyá»‡n: ${stats.total}`;
      document.getElementById('correct').textContent = `Tráº£ lá»i Ä‘Ãºng: ${stats.correct}`;
      document.getElementById('wrong').textContent = `Tráº£ lá»i sai: ${stats.wrong}`;
      const acc = stats.total > 0 ? Math.round(100 * stats.correct / stats.total) : 0;
      const wr = stats.total > 0 ? Math.round(100 * stats.wrong / stats.total) : 0;
      document.getElementById('accuracy').textContent = `Tá»‰ lá»‡ Ä‘Ãºng: ${acc}% - Sai: ${wr}%`;

      const list = stats.wrongWords.map(w => `<li>${w.Chinese} (${w.Pinyin}) - ${w.Meaning}</li>`).join('');
      document.getElementById('wrong-list').innerHTML = list ? `<strong>Tá»« sai:</strong><ul>${list}</ul>` : '';
    }

    function saveStats() {
      localStorage.setItem('vocabStats', JSON.stringify(stats));
    }

    function loadStats() {
      const saved = localStorage.getItem('vocabStats');
      if (saved) {
        stats = JSON.parse(saved);
        updateStats();
      }
    }

    function resetStats() {
      if (confirm("XÃ³a toÃ n bá»™ thá»‘ng kÃª?")) {
        localStorage.removeItem('vocabStats');
        stats = { total: 0, correct: 0, wrong: 0, wrongWords: [] };
        retryMode = false;
        updateStats();
        nextWord();
      }
    }

    function exportWrongWords() {
      if (!stats.wrongWords.length) return alert("KhÃ´ng cÃ³ tá»« sai.");
      const text = stats.wrongWords.map(w => `${w.Chinese} (${w.Pinyin}) - ${w.Meaning}`).join('\n');
      const blob = new Blob([text], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "tu_sai.txt";
      link.click();
    }

    function toggleLearningMode() {
      const btn = document.getElementById('toggleModeBtn');
      if (retryMode) {
        retryMode = false;
        retryIndex = 0;
        btn.textContent = "ğŸ“š Há»c tá»« (Táº¥t cáº£)";
      } else {
        if (!stats.wrongWords.length) return alert("KhÃ´ng cÃ³ tá»« sai.");
        retryMode = true;
        retryList = [...stats.wrongWords];
        retryIndex = 0;
        btn.textContent = "ğŸ“˜ Há»c tá»« (Tá»« sai)";
      }
      nextWord();
    }

    function openEdit() {
      document.getElementById('editChinese').value = current.Chinese;
      document.getElementById('editPinyin').value = current.Pinyin;
      document.getElementById('editMeaning').value = current.Meaning;
      document.getElementById('editModal').style.display = 'block';
    }

    function closeEdit() {
      document.getElementById('editModal').style.display = 'none';
    }

    function saveEdit() {
      current.Chinese = document.getElementById('editChinese').value;
      current.Pinyin = document.getElementById('editPinyin').value;
      current.Meaning = document.getElementById('editMeaning').value;
      editedWords.push({...current});
      updateWordDisplay();
      closeEdit();
    }

    function exportEditedWords() {
      if (!editedWords.length) return alert("ChÆ°a cÃ³ tá»« nÃ o Ä‘Æ°á»£c sá»­a.");
      const text = editedWords.map(w => `${w.Chinese} (${w.Pinyin}) - ${w.Meaning}`).join('\n');
      const blob = new Blob([text], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "tu_da_sua.txt";
      link.click();
    }

    // Nháº¥n Enter Ä‘á»ƒ kiá»ƒm tra
    answerInput.addEventListener("keyup", function(event) {
      if (event.key === "Enter") {
        checkAnswer();
      }
    });

    // Cháº¿ Ä‘á»™ sÃ¡ng/tá»‘i
    document.getElementById('darkToggle').addEventListener('change', function() {
      document.body.classList.toggle('dark-mode', this.checked);
    });
  </script>
</body>
</html>
